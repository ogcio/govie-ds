steps:
  - checkout: none
  - bash: |
      set -euo pipefail

      AZURE_DEVOPS_TICKETS_AREA_PATH='Digital Services Programme\\Design System'
      AZURE_DEVOPS_TICKETS_READY_TO_RELEASE_STATE='Ready to Release'
      AZURE_DEVOPS_TICKETS_READY_TO_CLOSED_STATE='Closed'

      ready_to_release_tickets_query="SELECT [System.Id] FROM workitems WHERE [System.AreaPath] = '$AZURE_DEVOPS_TICKETS_AREA_PATH' AND [System.State] = '$AZURE_DEVOPS_TICKETS_READY_TO_RELEASE_STATE'"
      ready_to_release_tickets_query_payload="{\"query\":\"$ready_to_release_tickets_query\"}"
      ready_to_release_tickets_ids=$(curl --silent --request POST --location "$AZURE_DEVOPS_BASE_URL/_apis/wit/wiql?api-version=7.2-preview.2" --header 'Accept: application/json' --header 'Content-Type: application/json' --user "$AZURE_DEVOPS_API_USERNAME:$AZURE_DEVOPS_API_TOKEN" --data "$ready_to_release_tickets_query_payload" | jq -r '.workItems | map(.id) | join(",")')
      IFS=',' read -ra ready_to_release_tickets_ids_array <<< "$ready_to_release_tickets_ids"

      current_date=$(date +"%Y-%m-%d")

      for ticket_id in "${ready_to_release_tickets_ids_array[@]}"
      do
          echo "Moving ticket with ID $ticket_id from $AZURE_DEVOPS_TICKETS_READY_TO_RELEASE_STATE to $AZURE_DEVOPS_TICKETS_READY_TO_CLOSED_STATE"
          update_ticket_payload="[{\"op\": \"add\",\"path\": \"/fields/System.State\",\"value\": \"$AZURE_DEVOPS_TICKETS_READY_TO_CLOSED_STATE\"},{\"op\": \"add\",\"path\": \"/fields/System.Reason\",\"value\": \"Released to PROD on $current_date\"}]"
          curl --silent --request PATCH --location "$AZURE_DEVOPS_BASE_URL/Digital%20Services%20Programme/_apis/wit/workitems/${ticket_id}?api-version=7.2-preview.3" --header 'Accept: application/json' --header 'Content-Type: application/json-patch+json' --user "$AZURE_DEVOPS_API_USERNAME:$AZURE_DEVOPS_API_TOKEN" --data "$update_ticket_payload"
          echo ''
          echo '---------------------------'
      done
    displayName: Close released tickets
    env:
      AZURE_DEVOPS_API_USERNAME: $(ADO_API_USERNAME)
      AZURE_DEVOPS_API_TOKEN: $(ADO_API_TOKEN)
      AZURE_DEVOPS_BASE_URL: $(ADO_BASE_URL)
