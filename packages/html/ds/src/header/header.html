{% from "header/assets/logo.html" import govieLogo %}
{% from "header/assets/logoSmall.html" import govieLogoSmall %}
{% from "icon/icon.html" import govieIcon %}
{% from "header/components/headerSearchContainer.html" import HeaderSearchContainer %}
{% from "header/components/headerMenu.html" import headerMenu %}
{% from "header/components/headerSlot.html" import govieSlotItemAction, govieSlotContainer %}

{% macro showMobileMenu(navLinks, tools, languages) %}
  {% set hasNavLinks = navLinks | length > 0 %}
  {% set hasMobileSlots = tools.items | selectattr("slot") | selectattr("keepOnMobile") | list | length > 0 %}
  {% set hasSearch = tools.search is defined %}
  {% set hasLanguages = languages | length > 0 %}

  {{ hasNavLinks or hasMobileSlots or hasSearch or hasLanguages }}
{% endmacro %}

{% macro govieHeader(props) %}
  {% set headerClassNames = "gi-header" %}
  {% set languageBarClassNames = "gi-header-language-bar" %}
  {% set languageItemClassNames = "gi-header-language-item" %}
  {% set menuContainerClassNames = "gi-header-menu" %}
  {% set logoLargeClassNames = "gi-header-logo-lg" %}
  {% set logoSmallClassNames = "gi-header-logo-sm" %}
  {% set appTitleClassNames = "gi-header-title" %}
  {% set toolItemClassNames = "gi-header-tool-item" %}
  {% set navLinkContainerClassNames = "gi-header-nav" %}
  {% set menuDividerClassNames = "gi-header-separator" %}
  {% set overlayClassNames = "gi-header-overlay" %}
  {% set containerClassName = "gi-layout-container-full-width" if props.fullWidth else "gi-layout-container" %}
  {% set toolItems = [] %}

  {% if 'tools' in props %}
    {% if 'items' in props.tools %}
      {% set toolItems = props.tools['items'] %}
    {% endif %}
  {% endif %}

  <header
    id="GovieHeader"
    class="{{ headerClassNames }}"
    data-module="gieds-header"
  >
    {% if props.languages %}
      <div class="{{ languageBarClassNames }}">
        <div class="{{ containerClassName }}">
          <ul>
            {% for link in props.languages %}
              <li>
                <a
                  data-testid="language-link-desktop-{{ loop.index0 }}"
                  class="{{ languageItemClassNames }}"
                  href="{{ link.href }}"
                  aria-label="{{ link.aria.label if link.aria and link.aria.label else '' }}"
                  aria-describedby="{{ link.aria.describedBy if link.aria and link.aria.describedBy else '' }}"
                >
                  {{ link.label }}
                </a>
              </li>
            {% endfor %}
          </ul>
        </div>
      </div>
    {% endif %}

    <div id="HeaderContainer" class="{{ containerClassName }}">
      <div class="{{ menuContainerClassNames }}">
        <div class="gi-header-logo">
          {% if props.logo and props.logo.href %}
            <a
              href="{{ props.logo.href }}"
              aria-label="{{ props.logo.aria.label if props.logo.aria and props.logo.aria.label else 'Go to the home page' }}"
              aria-describedby="{{ props.logo.aria.describedBy if props.logo.aria and props.logo.aria.describedBy else '' }}"
            >
              <span class="{{ logoLargeClassNames }}">{{ govieLogo() }}</span>
              <span class="{{ logoSmallClassNames }}"
                >{{ govieLogoSmall() }}</span
              >
            </a>
          {% else %}
            <span class="{{ logoLargeClassNames }}">{{ govieLogo() }}</span>
            <span class="{{ logoSmallClassNames }}"
              >{{ govieLogoSmall() }}</span
            >
          {% endif %}
        </div>

        <div class="{{ appTitleClassNames }}">
          {% if props.title %}{{ props.title }}{% endif %}
        </div>

        <ul
          id="links-container-desktop"
          class="{{ navLinkContainerClassNames }}"
        >
          {% for link in props.navLinks %}
            <li class="gi-flex">
              <a
                href="{{ link.href }}"
                data-testid="nav-link-desktop-{{ loop.index0 }}"
                aria-label="{{ link.aria.label if link.aria and link.aria.label else '' }}"
                aria-describedby="{{ link.aria.describedBy if link.aria and link.aria.describedBy else '' }}"
              >
                {{ link.label }}
              </a>
            </li>
          {% endfor %}
        </ul>

        {% if props.navLinks and (props.tools.search or props.tools.items) %}
          <div class="{{ menuDividerClassNames }}"></div>
        {% endif %}

        <div class="gi-flex">
          {% if props.tools and props.tools.search %}
            <label for="SearchTrigger" class="{{ toolItemClassNames }}">
              <input
                id="SearchTrigger"
                type="checkbox"
                class="gi-block gi-w-0 gi-absolute gi-h-0"
                data-testid="SearchTrigger"
                aria-label="{{ props.tools.search.aria.label if props.tools.search.aria and props.tools.search.aria.label else '' }}"
                aria-describedby="{{ props.tools.search.aria.describedBy if props.tools.search.aria and props.tools.search.aria.describedBy else '' }}"
              />
              {% if props.tools.search.label %}
                <span class="label">{{ props.tools.search.label }}</span>
              {% endif %}
              <div class="search-icon">
                {{ govieIcon({"icon": props.tools.search.icon or "search" }) }}
              </div>
              <div class="gi-hidden close-icon">
                {{ govieIcon({"icon": "close"}) }}
              </div>
            </label>
          {% endif %}

          {% for toolItem in toolItems %}
            <div class="gi-hidden lg:gi-flex">
              {% if toolItem.slot %}
                {{ govieSlotItemAction(toolItem, loop.index0) }}
              {% else %}
                <a
                  href="{{ toolItem.href }}"
                  class="{{ toolItemClassNames }}"
                  aria-label="{{ toolItem.aria.label if toolItem.aria and toolItem.aria.label else toolItem.label }}"
                  aria-describedby="{{ toolItem.aria.describedBy if toolItem.aria and toolItem.aria.describedBy else '' }}"
                >
                  {% if toolItem.label %}
                    <span class="label">{{ toolItem.label }}</span>
                  {% endif %}
                  {% if toolItem.icon %}
                    {{ govieIcon({"icon": toolItem.icon}) }}
                  {% endif %}
                </a>
              {% endif %}
            </div>
          {% endfor %}

          {% if showMobileMenu(props.navLinks, props.tools, props.languages) %}
            <label
              for="MobileMenuTrigger"
              class="{{ toolItemClassNames }} lg:gi-hidden"
            >
              <input
                id="MobileMenuTrigger"
                type="checkbox"
                class="gi-block gi-w-0 gi-absolute gi-h-0"
                aria-label="{{ props.tools.menu.aria.label if props.tools.menu.aria and props.tools.menu.aria.label else '' }}"
                aria-expanded="{{ props.tools.menu.aria.expanded if props.tools.menu.aria and props.tools.menu.aria.expanded else '' }}"
              />
              {% if props.tools.menu.label %}
                <span class="label">{{ props.tools.menu.label }}</span>
              {% endif %}
              <div>
                {{ govieIcon({"icon": props.tools.menu.icon or "menu"}) }}
              </div>
            </label>
          {% endif %}
        </div>
      </div>
    </div>

    {% if props.tools and props.tools.search %}
      <div
        id="SearchContainer"
        class="gi-hidden gi-bg-gray-50 gi-px-8 gi-pt-8 gi-pb-14 gi-border-b-2xl gi-border-b-emerald-800"
      >
        {{ HeaderSearchContainer({"searchUrl": props.tools.search.action, "icon": props.tools.search.icon or "search"}) }}
      </div>
    {% endif %}

    {{ headerMenu(props) }}

    <div
      id="HeaderOverlayContainer"
      class="{{ overlayClassNames }}"
      data-element="overlay-disabled"
    ></div>

    {% for toolItem in toolItems %}
      {% if toolItem.slot %}
        {{ govieSlotContainer(loop.index0, toolItem.slot) }}
      {% endif %}
    {% endfor %}
  </header>
{% endmacro %}
